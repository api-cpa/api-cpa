<% content_for(:page_title) { t('misc.overview') } %>

<div class="b-io-content--secondary">
  <div class="container-fluid">

    <div class="row">
      <div class="col-3 text-right">
        <strong><%= t('activerecord.attributes.contract.status') %></strong>
      </div>
      <div class="col-9">
        <strong><i class="<%= t("types.contract_statuses.#{@contract.status}.icon") %>"></i> <span class="<%= t("types.contract_statuses.#{@contract.status}.class") %>"><%= t("types.contract_statuses.#{@contract.status}.title") %></span></strong><br />
        <small class="text-muted"><%= t("types.contract_statuses.#{@contract.status}.description") %></small>
      </div>
    </div>

    <hr>
    <div class="row">
      <div class="col-3 text-right">
        <strong><%= t('activerecord.attributes.contract.startup') %></strong>
      </div>
      <div class="col-9">
        <strong><i class="<%= t("types.service_types.#{@contract.startup.service_type}.icon") %>"></i> <span class="<%= t("types.service_types.#{@contract.startup.service_type}.class") %>"><%= @contract.startup.name %></span></strong><br />
        <small class="text-muted"><%= simple_format(@contract.startup.description) %></small>
      </div>
    </div>

    <hr>
    <div class="row">
      <div class="col-3 text-right">
        <strong><%= t('activerecord.attributes.contract.proxy') %></strong>
      </div>
      <div class="col-9">
        <i class="fa fa-fw fa-sitemap"></i> <strong><%= @contract.proxy.name %></strong><br />
        <small class="text-muted"><%= simple_format(@contract.proxy.description) %></small>
      </div>
    </div>

    <hr>
    <div class="row">
      <div class="col-3 text-right">
        <strong><%= t('activerecord.attributes.contract.contract_duration_type') %></strong>
      </div>
      <div class="col-9">
        <%= t("types.contract_duration_types.#{@contract.contract_duration_type}.title") %>
      </div>
    </div>

    <hr>
    <div class="row">
      <div class="col-3 text-right">
        <strong><%= t('activerecord.attributes.contract.expected_start_date') %></strong>
      </div>
      <div class="col-9">
        <%= l(@contract.expected_start_date, format: :long) %>
      </div>
    </div>

    <hr>
    <div class="row">
      <div class="col-3 text-right">
        <strong><%= t('activerecord.attributes.contract.expected_end_date') %></strong>
      </div>
      <div class="col-9">
        <%= l(@contract.expected_end_date, format: :long) %> <%= t('misc.included') %> (<%= "#{@contract.expected_contract_duration} #{t('misc.day', count: @contract.expected_contract_duration)}" %>)
      </div>
    </div>

    <hr>
    <div class="row">
      <div class="col-3 text-right">
        <strong><%= t('activerecord.attributes.contract.is_evergreen') %></strong>
      </div>
      <div class="col-9">
        <%= t("misc.#{@contract.is_evergreen}") %>
      </div>
    </div>


    <% if @contract.comments.active.count > 0 %>

      <hr>
      <div class="row">
        <div class="col-3 text-right">
          <strong><%= t('misc.last_comment') %></strong>
        </div>
        <div class="col-9">
          <div class="float-right">
            <%= link_to "<i class=\"fa fa-fw fa-comments\"></i> #{t('actions.see_and_add_comments').pluralize}".html_safe, (current_service.nil? ? comments_contract_path(@contract) : comments_service_contract_path(current_service, @contract)), class: 'btn btn-sm btn-secondary' %>
          </div>
          <%= render partial: 'comments/comment', locals: {comment: @contract.comments.active.last, mode: :inline} %>
        </div>
      </div>

    <% end %>

    <hr>
    <div class="row">
      <div class="col-3 text-right">
        <strong><%= t('misc.general_condition_to_valide') %></strong>
      </div>
      <div class="col-2">
        <%= link_to @contract.general_condition.name, (current_service.nil? ? general_condition_contract_path(@contract) : general_condition_service_contract_path(current_service, @contract)) %>
      </div>
      <div class="col-7 text-left">

        <% status, errors = @contract.can?(current_user, :validate_general_condition) %>
        <% if status %>
          <%= button_to t('actions.accept'), (current_service.nil? ? validate_general_condition_contract_path(@contract) : validate_general_condition_service_contract_path(current_service, @contract)), class: 'btn btn-danger', method: :post, data: { confirm: "Are you sure?" } %>
        <% end %>
        <% errors.each do |err| %>
            <p><%= err %></p>
        <% end if errors %>
        <% if !@contract.general_condition_validated_client_id.nil? %>
          <%= t('actions.accept_by') + ' ' + @contract.general_condition_validated_client.full_name + ' ' + l(@contract.validation_date, format: :long) %>
        <%  elsif !status %>
          <%= t('actions.not_accept_by') + ' ' + t('types.service_types.client.title')%>
        <% end %>

        <% status, errors = @contract.can?(current_user, :reject_general_condition) %>
        <% if status %>
          <div class="pull-right">
            <%= button_to t('actions.reject'), (current_service.nil? ? reject_general_condition_contract_path(@contract) : reject_general_condition_service_contract_path(current_service, @contract)), class: 'btn btn-danger', method: :post, data: { confirm: "Are you sure?" } %>
          </div>
        <% end %>
        <% errors.each do |err| %>
            <p><%= err %></p>
        <% end if errors %>

      </div>
    </div>
    <hr>

    <div class="row">
      <div class="col-3 text-right">
        <strong><%= t('misc.actions') %></strong>
      </div>
      <div class="col-9">

        <% status, errors = @contract.can?(current_user, :cancel) %>
        <% if status %>
          <div class="pull-right">
            <%= button_to t('actions.cancel_contract'), (current_service.nil? ? cancel_contract_path(@contract) : cancel_service_contract_path(current_service, @contract)), class: 'btn btn-danger', method: :post, data: { confirm: "Are you sure?" } %>
          </div>
        <% end %>
        <% errors.each do |err| %>
            <p><%= err %></p>
        <% end if errors%>

        <% status, errors = @contract.can?(current_user, :edit) %>
        <% if status %>
          <%= link_to t('actions.edit'), (current_service.nil? ? edit_contract_path(@contract) : edit_service_contract_path(current_service, @contract)), class: 'btn btn-lg btn-primary' %>
        <% end %>
        <% errors.each do |err| %>
            <p><%= err %></p>
        <% end if errors%>

        <% status, errors = @contract.can?(current_user, :prices) %>
        <% if status %>
          <%= link_to t('actions.edit_price'), (current_service.nil? ? prices_contract_path(@contract) : prices_service_contract_path(current_service, @contract)), class: 'btn btn-lg btn-primary' %>
        <% end %>
        <% errors.each do |err| %>
            <p><%= err %></p>
        <% end if errors%>

        <% status, errors = @contract.can?(current_user, :validate) %>
        <% if status %>
          <%= link_to t('actions.next_step'), (current_service.nil? ? validate_contract_path(@contract) : validate_service_contract_path(current_service, @contract)), class: 'btn btn-lg btn-primary', method: :post %>
        <% elsif !@contract.status_config[:next].nil?  %>
          <p><%= t('misc.waiting_for_validation') %></p>
        <% end %>
        <% errors.each do |err| %>
            <p><%= err %></p>
        <% end if errors%>

        <% status, errors = @contract.can?(current_user, :toggle_production) %>
        <% if status %>
          <%= link_to t("actions.#{'un' if @contract.production}set_production"), (current_service.nil? ? toggle_production_contract_path(@contract) : toggle_production_service_contract_path(current_service, @contract)), class: 'btn btn-primary btn-lg', method: :post %>
        <% end %>
        <% errors.each do |err| %>
            <p><%= err %></p>
        <% end if errors%>

        <% status, errors = @contract.can?(current_user, :reject) %>
        <% if status %>
          <%= link_to t('actions.reject'), (current_service.nil? ? reject_contract_path(@contract) : reject_service_contract_path(current_service, @contract)), class: 'btn btn-lg btn-danger', method: :post %>
        <% end %>
        <% errors.each do |err| %>
            <p><%= err %></p>
        <% end if errors%>
      </div>
    </div>

  </div>
</div>

<div class="b-io-content--header">
  <div class="container-fluid">
    <div class="b-io-content--header--controls"></div>
    <h4><%= t('activerecord.attributes.contract.client') %></h4>
  </div>
</div>
<div class="b-io-content--secondary">
  <div class="container-fluid">
    <%= render partial: 'services/show_service_info', locals: {service: @contract.client} %>
  </div>
</div>

<div class="b-io-content--header">
  <div class="container-fluid">
    <div class="b-io-content--header--controls"></div>
    <h4><%= t('activerecord.attributes.contract.startup') %></h4>
  </div>
</div>
<div class="b-io-content--secondary">
  <div class="container-fluid">
    <%= render partial: 'services/show_service_info', locals: {service: @contract.startup} %>
  </div>
</div>

<div class="b-io-content--header">
  <div class="container-fluid">
    <div class="b-io-content--header--controls"></div>
    <h4><%= t('activerecord.attributes.contract.proxy') %></h4>
  </div>
</div>
<div class="b-io-content--secondary">
  <div class="container-fluid">
    <%= render partial: 'proxies/show_proxy_info', locals: {proxy: @contract.proxy} %>
  </div>
</div>