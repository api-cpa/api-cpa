<div class="ui container">
  <% include ../services/_header %>

  <div class="ui segment">
    <button class="ui button" id="show_client_id_btn">
      <i class="lock icon"></i>
      Afficher la clef publique
    </button>
    <button class="ui button" id="show_client_secret_btn">
      <i class="lock icon"></i>
      Afficher la clef secrète
    </button>
    <button class="ui button" id="generate_token_btn">
      <i class="add icon"></i>
      Générer un jeton
    </button>
  </div>
  <% if (tokens.length > 0) { %>
  <table class="ui <% if (tokens.length > 1) { %>sortable<% } %> celled table">
    <thead>
    <tr>
      <th>État</th>
      <th class="six wide no-sort">Token</th>
      <th class="sort-by-date">Dernière utilisation</th>
      <th class="sort-by-date">Expiration</th>
      <th>Stats</th>
      <th class="two wide no-sort"></th>
    </tr>
    </thead>
    <tbody>
    <% tokens.forEach(function(token) { %>
      <tr class="<% if(token.accessTokenExpiresOn < now) { %>warning<% } %>">
        <td>
          <% if(token.accessTokenExpiresOn >= now) { %>
          <div class="ui ribbon label">Actif</div>
          <% } else { %>
          Expiré
          <% } %>
        </td>
        <td>
          <div class="ui fluid left icon input">
            <input type="text" value="<%= token.accessToken %>">
            <i class="file code outline icon"></i>
          </div>
        </td>
        <td><% if (token.updatedAt || token.createdAt) { %><%= token.updatedAt ? token.updatedAt.toISOString() : token.createdAt.toISOString() %><% } %></td>
        <td><% if (token.accessTokenExpiresOn) { %><%= token.accessTokenExpiresOn.toISOString() %><% } %></td>
        <td>
          <%= token.nbOfUse %> time(s)
        </td>
        <td>
          <% if(token.accessTokenExpiresOn >= now) { %>
            <form method="post" action="/dashboard/services/<%= data.service.nameNormalized %>/tokens/<%= token.accessToken %>/revoke">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button type="submit" class="ui tiny fluid labeled icon button">
                <i class="pause icon"></i>
                Révoquer
              </button>
            </form>
          <% } else { %>
            <form method="post" action="/dashboard/services/<%= data.service.nameNormalized %>/tokens/<%= token.accessToken %>/destroy">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button type="submit" class="ui tiny fluid labeled icon button">
                <i class="trash icon"></i>
                Supprimer
              </button>
            </form>
          <% } %>
        </td>
      </tr>
    <% }) %>
    </tbody>
  </table>
  <% include ../../../partials/_pagination %>
  <% } else { %>
  <div class="ui segment">
    Vous n'avez généré aucun jeton de connexion
  </div>
  <% } %>
</div>


<form id="generate_token_form" method="post" action="/dashboard/services/<%= data.service.nameNormalized %>/tokens/generate">
  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
</form>
<form id="show_client_secret_form" method="post" action="/dashboard/services/<%= data.service.nameNormalized %>/clientSecret">
  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
  <input type="hidden" name="redirect_url" value="/dashboard/services/<%= data.service.nameNormalized %>/tokens">
</form>
<form id="show_client_id_form" method="post" action="/dashboard/services/<%= data.service.nameNormalized %>/clientId">
  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
  <input type="hidden" name="redirect_url" value="/dashboard/services/<%= data.service.nameNormalized %>/tokens">
</form>

<script>
  $(document).ready(function() {
    $('#generate_token_btn').on('click', function(e) {
      document.getElementById('generate_token_form').submit();
    });
    $('#show_client_secret_btn').on('click', function(e) {
      document.getElementById('show_client_secret_form').submit();
    });
    $('#show_client_id_btn').on('click', function(e) {
      document.getElementById('show_client_id_form').submit();
    });
  });
</script>